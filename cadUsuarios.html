<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <title>Master Detail - Teste Front End</title>
</head>

<body>

  <div class="wrapper">

    <form class="cad-form">
      <div class="input-wrapper">
        <span style="display: none" id="nome-error" class="message-error" aria-live="polite">Campo deve conter 3
          caracteres ou mais</span>
        <input type="text" id="nome" name="nome" required pattern="[A-Za-z]{3,}">
        <label for="nome">Nome completo(sem abreviações)</label>
      </div>

      <div class="input-wrapper">
        <span style="display: none" id="email-error" class="message-error" aria-live="polite">Esse não é um email
          válido</span>
        <input type="email" id="email" required name="email">
        <label for="email">Email</label>
      </div>

      <div class="input-wrapper">
        <span style="display: none" id="cpf-error" class="message-error" aria-live="polite">Esse CPF não é válido</span>
        <input type="text" id="cpf" name="cpf" required pattern="\d{3}\.\d{3}\.\d{3}-\d{2}" maxlength="14">
        <label for="cpf">CPF</label>
      </div>

      <div class="input-wrapper">
        <span style="display: none" id="telefone-error" class="message-error" aria-live="polite">Esse Telefone não é
          válido</span>
        <input type="text" id="telefone" name="telefone" required pattern="\([0-9]{2}\)[\s][0-9]{4,5}-[0-9]{4}">
        <label for="telefone">Telefone:</label>
      </div>

      <div class="btn-actions">
        <button id="btn-submit" class="btn btn-submit" type="button">Cadastrar</button>
      </div>
    </form>

  </div>

</body>

<script type="text/javascript">
  const name = document.getElementById("nome");
  const cpf = document.getElementById("cpf");
  const email = document.getElementById("email");
  const phone = document.getElementById("telefone");

  const editUser = JSON.parse(sessionStorage.getItem('editUser'))
  
  if(editUser) {
    cpf.disabled = true;
    name.value = editUser.name;
    cpf.value = editUser.cpf;
    email.value = editUser.email;
    phone.value = editUser.phone
  }

  name.addEventListener("input", () => {
    const error = document.getElementById('nome-error');
    if(name.validity.valid) {
      error.style.display = 'none';
      formValidation.name = true;
    } else {
      error.style.display = 'block';
      formValidation.name = false;
    }
  }, false);

  cpf.addEventListener("input", () => {
    const error = document.getElementById('cpf-error');
    cpf.validity.valid ? error.style.display = 'none' : error.style.display = 'block';
  }, false);

  phone.addEventListener("input", () => {
    const error = document.getElementById('telefone-error');
    phone.validity.valid ? error.style.display = 'none' : error.style.display = 'block';
  }, false);

  email.addEventListener("input", () => {
    const error = document.getElementById('email-error');
    email.validity.valid ? error.style.display = 'none' : error.style.display = 'block';
  }, false);

</script>



<script type="text/javascript">

  const saveUser = (event) => {
    let isFormValid;
    

    const editUser = JSON.parse(sessionStorage.getItem('editUser'));
    let storage = JSON.parse(sessionStorage.getItem('users'));

    const name = document.getElementById("nome");
    const cpf = document.getElementById("cpf");
    const email = document.getElementById("email");
    const phone = document.getElementById("telefone");
    
    const form = { 
      name: name.value, 
      cpf: cpf.value, 
      email: email.value, 
      phone: phone.value
    }

    const validation = {
      name: name.validity.valid,
      cpf: cpf.validity.valid,
      email: email.validity.valid,
      phone: phone.validity.valid
    }

    console.log('salvar validation', validation)

    

    console.log('isFormValid', isFormValid)
    
    if (editUser && isFormValid) {
      let newArray = storage.filter((user) => editUser.cpf !== user.cpf)
      console.log('filter', newArray)
      newArray.push(form);
      console.log('new', newArray)
      sessionStorage.setItem('users', JSON.stringify(newArray));
      storage = JSON.parse(sessionStorage.getItem('users'));
      sessionStorage.removeItem('editUser');
      window.location.replace("listaUsuarios.html");
    } else if(isFormValid)  {
      const newStorage = storage.push(form)
      sessionStorage.setItem('users', JSON.stringify(storage));
      window.location.replace("listaUsuarios.html");
    }
}

</script>


<script type="module">

  import User from './js/user.js'

  document.getElementById('btn-submit').addEventListener('click', () => {
    let isFormValid;
    const form = { 
      name: document.getElementById("nome").value, 
      cpf: document.getElementById("cpf").value, 
      email: document.getElementById("email").value, 
      phone: document.getElementById("telefone").value
    }

    const validation = {
      name: document.getElementById("nome").validity.valid,
      cpf: document.getElementById("cpf").validity.valid,
      email: document.getElementById("email").validity.valid,
      phone: document.getElementById("telefone").validity.valid
    }
    console.log('form', form)
    Object.keys(validation).forEach(each => {
      if(!validation[each]) {
        isFormValid = false;
      } else {
        isFormValid = true;
      }
    })

    if(isFormValid) {
      const user = new User().saveUser(form);
    }
    
  })
  

</script>

<script type="module">
  import Valida from './js/valida.js';

  document.getElementById('cpf').addEventListener('input', (cpf) => {

    if(cpf.target.value.length === 14) {
      const str = cpf.target.value.replaceAll('.', '').replaceAll('-', '');
      const isCpfValid = new Valida().valida_cpf(str);
      console.log('validade', isCpfValid)
    }
  }) 
</script>

</html>