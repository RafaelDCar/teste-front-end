<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <title>Master Detail - Teste Front End</title>
</head>

<body>

  <div class="wrapper">

    <form class="cad-form">
      <div class="input-wrapper">
        <span style="display: none" id="nome-error" class="message-error" aria-live="polite">Campo deve conter 3
          caracteres ou mais</span>
        <input type="text" id="nome" name="nome" required pattern="[A-Za-z]{3,}">
        <label for="nome">Nome completo(sem abreviações)</label>
      </div>

      <div class="input-wrapper">
        <span style="display: none" id="email-error" class="message-error" aria-live="polite">Esse não é um email
          válido</span>
        <input type="email" id="email" required name="email">
        <label for="email">Email</label>
      </div>

      <div class="input-wrapper">
        <span style="display: none" id="cpf-error" class="message-error" aria-live="polite">Esse CPF não é válido</span>
        <input type="text" id="cpf" name="cpf" required pattern="\d{3}\.\d{3}\.\d{3}-\d{2}" maxlength="14">
        <label for="cpf">CPF</label>
      </div>

      <div class="input-wrapper">
        <span style="display: none" id="telefone-error" class="message-error" aria-live="polite">Esse Telefone não é
          válido</span>
        <input type="text" id="telefone" name="telefone" required pattern="\([0-9]{2}\)[\s][0-9]{4,5}-[0-9]{4}">
        <label for="telefone">Telefone:</label>
      </div>

      <div class="btn-actions">
        <button id="btn-submit" class="btn btn-submit" onclick="saveUser()" type="button">Cadastrar</button>
      </div>
    </form>

  </div>

</body>

<script type="text/javascript">
  const name = document.getElementById("nome");
  const cpf = document.getElementById("cpf");
  const email = document.getElementById("email");
  const phone = document.getElementById("telefone");

  const editUser = JSON.parse(sessionStorage.getItem('editUser'))
  if(editUser) {
    cpf.disabled = true;
    name.value = editUser.name;
    cpf.value = editUser.cpf;
    email.value = editUser.email;
    phone.value = editUser.phone
  }

  const formValidation = {
    name: name.validity.valid,
    cpf: cpf.validity.valid,
    email: email.validity.valid,
    phone: phone.validity.valid
  }

  name.addEventListener("input", () => {
    const error = document.getElementById('nome-error');
    if(name.validity.valid) {
      error.style.display = 'none';
      formValidation.name = true;
    } else {
      error.style.display = 'block';
      formValidation.name = false;
    }
  }, false);

  cpf.addEventListener("input", () => {
    const error = document.getElementById('cpf-error');
   
    if(cpf.value.length === 14) {

      const str = cpf.value.replaceAll('.', '').replaceAll('-', '');
      const validade = valida_cpf(str);
      console.log('validade', validade)
    }
    cpf.validity.valid ? error.style.display = 'none' : error.style.display = 'block';
  }, false);

  phone.addEventListener("input", () => {
    const error = document.getElementById('telefone-error');
    phone.validity.valid ? error.style.display = 'none' : error.style.display = 'block';
  }, false);

  email.addEventListener("input", () => {
    const error = document.getElementById('email-error');
    email.validity.valid ? error.style.display = 'none' : error.style.display = 'block';
  }, false);

  console.log('formValidation',formValidation)
</script>

<script type="text/javascript">
  function valida_cpf(cpf) {
    var numeros, digitos, soma, i, resultado, digitos_iguais;
    digitos_iguais = 1;
    if (cpf.length < 11)
      return false;
    for (i = 0; i < cpf.length - 1; i++)
      if (cpf.charAt(i) != cpf.charAt(i + 1)) {
        digitos_iguais = 0;
        break;
      }
    if (!digitos_iguais) {
      numeros = cpf.substring(0, 9);
      digitos = cpf.substring(9);
      soma = 0;
      for (i = 10; i > 1; i--)
        soma += numeros.charAt(10 - i) * i;
      resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
      if (resultado != digitos.charAt(0))
        return false;
      numeros = cpf.substring(0, 10);
      soma = 0;
      for (i = 11; i > 1; i--)
        soma += numeros.charAt(11 - i) * i;
      resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
      if (resultado != digitos.charAt(1))
        return false;
      return true;
    } else
      return false;
  }
</script>

<script type="text/javascript">

  const saveUser = (event) => {
    let isFormValid;
    

    const editUser = JSON.parse(sessionStorage.getItem('editUser'))
    const name = document.getElementById("nome");
    const cpf = document.getElementById("cpf");
    const email = document.getElementById("email");
    const phone = document.getElementById("telefone");
    
    const form = { 
      name: name.value, 
      cpf: cpf.value, 
      email: email.value, 
      phone: phone.value
    }
    let storage = JSON.parse(sessionStorage.getItem('users'));
  
    console.log('storage', storage);

    const validation = {
      name: name.validity.valid,
      cpf: cpf.validity.valid,
      email: email.validity.valid,
      phone: phone.validity.valid
    }
    console.log('salvar validation', validation)

    Object.keys(validation).forEach(each => {
      console.log(each)
      console.log(`${each}`, validation[each])
      if(!validation[each]) {
        isFormValid = false;
      } else {
        isFormValid = true;
      }
    })

    console.log('isFormValid', isFormValid)
    
    if (editUser && isFormValid) {
      let newArray = storage.filter((user) => editUser.cpf !== user.cpf)
      console.log('filter', newArray)
      newArray.push(form);
      console.log('new', newArray)
      sessionStorage.setItem('users', JSON.stringify(newArray));
      storage = JSON.parse(sessionStorage.getItem('users'));
      sessionStorage.removeItem('editUser');
      window.location.replace("listaUsuarios.html");
    } else if(isFormValid)  {
      const newStorage = storage.push(form)
      sessionStorage.setItem('users', JSON.stringify(storage));
      window.location.replace("listaUsuarios.html");
    }
    
    

}

</script>

<script type="text/javascript">
  // const btn = document.getElementById('btn-submit').disabled = true;

  
</script>

<script src="./js/index.js"></script>

</html>